#!/usr/bin/env ruby
require './config/default_includes'
Thread.abort_on_exception = true

$logger.info { 'Metrics collector will check for new inventory every 30 seconds' }
collector = MetricsCollector.new
loop do
  InventoriedTimestamp.ready_for_metering.each do |it|
    it.update_attribute(:record_status, 'queued_for_metering')
    collector.run(it)
  end
  File.write("/tmp/heartbeat", "")  # for kubernetes health check
  sleep 30
end

